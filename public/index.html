<!DOCTYPE html>
<html>
  <head>
    <title>Spotify Artist Search</title>
    <link rel="stylesheet" type="text/css" href="spotify.css" />
  </head>
  <body>
    <div id="app">
      <auth-component
        v-if="!isAuthorized"
        @authorize="authorizeUser"
        :clientId="clientId"
        :redirectUri="redirectUri"
      ></auth-component>
      <button @click="logOut">Log out</button>
      <search-bar v-if="isAuthorized" @search="searchArtists"></search-bar>
      <search-results
        v-if="searchResults.length > 0"
        :results="searchResults"
      ></search-results>
    </div>

    <script src="https://unpkg.com/vue@3.2.6/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script>
      const AuthComponent = {
        props: ['clientId', 'redirectUri'],
        template: `
                          <div class="auth-container">
                            <h1>Spotify Artist Search</h1>
                            <p>Please log in with Spotify to use the Spotify API.</p>
                            <button @click="authorize">Log in with Spotify</button>
                          </div>
                        `,
        methods: {
          authorize() {
            const codeVerifier = this.generateRandomString(64)
            this.generateCodeChallenge(codeVerifier).then(code_challenge => {
              const clientId = 'd12d177d818048baa656df823fc9137d'
              const redirectUri = 'http://127.0.0.1:8080/'
              window.localStorage.setItem('codeVerifier', codeVerifier)

              window.location = this.generateUrlWithSearchParams(
                'https://accounts.spotify.com/authorize',
                {
                  response_type: 'code',
                  client_id: clientId,
                  scope: 'user-read-private user-read-email',
                  code_challenge_method: 'S256',
                  code_challenge,
                  redirect_uri: redirectUri
                }
              )
            })
          },
          generateUrlWithSearchParams(url, params) {
            const urlObject = new URL(url)
            urlObject.search = new URLSearchParams(params).toString()

            return urlObject.toString()
          },
          generateRandomString(length) {
            let text = ''
            let possible =
              'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'

            for (let i = 0; i < length; i++) {
              text += possible.charAt(
                Math.floor(Math.random() * possible.length)
              )
            }
            return text
          },
          async generateCodeChallenge(codeVerifier) {
            async function sha256(plain) {
              const encoder = new TextEncoder()
              const data = encoder.encode(plain)

              return window.crypto.subtle.digest('SHA-256', data)
            }

            function base64urlencode(array) {
              return btoa(
                String.fromCharCode.apply(null, new Uint8Array(array))
              )
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '')
            }

            const hashed = await sha256(codeVerifier)
            return base64urlencode(hashed)
          }
        }
      }

      const SearchBar = {
        data() {
          return {
            artistName: ''
          }
        },
        template: `
                                <div class="search-container">
                                  <h1>Spotify Artist Search</h1>
                                  <form @submit.prevent="search">
                                    <label for="artist">Artist:</label>
                                    <input type="text" id="artist" v-model="artistName">
                                    <button type="submit">Search</button>
                                  </form>
                                </div>
                              `,
        methods: {
          search() {
            this.$emit('search', this.artistName)
          }
        }
      }

      const SearchResults = {
        props: ['results'],
        template: `
                                <div class="results-container">
                                  <h2>Search Results</h2>
                                  <ul>
                                    <li v-for="result in results" :key="result.id">
                                      <h3>{{ result.name }}</h3>
                                      <img :src="result.image" alt="Artist Image">
                                      <ul>
                                        <li v-for="song in result.songs" :key="song">{{ song }}</li>
                                      </ul>
                                    </li>
                                  </ul>
                                </div>
                              `
      }

      const loginBar = {
        props: ['results'],
        template: `
                                <div class="results-container">
                                  <h2>Search Results</h2>
                                  <ul>
                                    <li v-for="result in results" :key="result.id">
                                      <h3>{{ result.name }}</h3>
                                      <img :src="result.image" alt="Artist Image">
                                      <ul>
                                        <li v-for="song in result.songs" :key="song">{{ song }}</li>
                                      </ul>
                                    </li>
                                  </ul>
                                </div>
                              `
      }

      const app = Vue.createApp({
        data() {
          return {
            status: 'none',
            post: null,
            error: null,
            accessToken: '',
            clientId: 'd12d177d818048baa656df823fc9137d',
            redirectUri: 'http://127.0.0.1:8080/',
            searchResults: []
          }
        },
        created() {
          const code = new URLSearchParams(window.location.search).get('code')
          if (localStorage.getItem('access_token')) {
            console.log(localStorage.getItem('access_token'))
          } else if (code) {
            this.exchangeToken(code)
          } else {
            this.accessToken = ''
          }
        },
        methods: {
          logOut() {
            localStorage.clear()
            this.accessToken = ''
            window.location = this.redirectUri
          },
          test() {
            const codeVerifier = new URLSearchParams(
              window.location.search
            ).get('code')
            const code_verifier = localStorage.getItem('codeVerifier')
            const codeChallenge = generateCodeChallenge(code_verifier)

            console.log(verifyCodeChallenge(codeVerifier, codeChallenge))

            async function generateCodeChallenge(codeVerifier) {
              const digest = await crypto.subtle.digest(
                'SHA-256',
                new TextEncoder().encode(codeVerifier)
              )

              return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
            }

            function verifyCodeChallenge(codeVerifier, codeChallenge) {
              const encodedVerifier = base64UrlEncode(codeVerifier)

              // Generate the expected code challenge based on the code verifier
              const expectedCodeChallenge = sha256(encodedVerifier)

              // Compare the expected code challenge with the provided code challenge

              console.log('expectedCodeChallenge :>> ', expectedCodeChallenge)
              console.log('codeChallenge :>> ', codeChallenge)
              return expectedCodeChallenge === codeChallenge
            }

            // Helper function to base64 URL encode a string
            function base64UrlEncode(str) {
              let base64 = btoa(str)
              base64 = base64
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '')
              return base64
            }

            // Helper function to compute the SHA-256 hash of a string
            async function sha256(str) {
              const encoder = new TextEncoder()
              const data = encoder.encode(str)

              const hashBuffer = await crypto.subtle.digest('SHA-256', data)

              const hashArray = Array.from(new Uint8Array(hashBuffer))

              const hashHex = hashArray
                .map(byte => byte.toString(16).padStart(2, '0'))
                .join('')

              return hashHex
            }
          },
          authorizeUser() {
            // Handle user authorization logic
            // Set 'isAuthorized' to true once the user is authorized
            this.isAuthorized = true
          },
          async searchArtists(artistName) {
            try {
              this.error = this.post = null
              this.loading = true
              const response = await fetch(
                `https://api.spotify.com/v1/search?q=${artistName}&type=artist`
              )
              const data = await response.json()

              // Extract relevant information from the API response
              const artists = data.artists.items.map(artist => ({
                id: artist.id,
                name: artist.name,
                image: artist.images[0]?.url || '',
                albums: []
              }))

              this.searchResults = artists
            } catch (error) {
              this.error = true
              this.loading = this.post = null
              console.error(error)
            }
          },
          async exchangeToken(code) {
            let codeVerifier = localStorage.getItem('codeVerifier')

            let body = new URLSearchParams({
              grant_type: 'authorization_code',
              code: code,
              redirect_uri: this.redirectUri,
              client_id: this.clientId,
              code_verifier: codeVerifier
            })
            const response = await fetch(
              'https://accounts.spotify.com/api/token',
              {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body
              }
            )
              .then(response => {
                if (!response.ok) {
                  throw new Error('HTTP status ' + response.status)
                }
                return response.json()
              })
              .then(data => {
                localStorage.setItem('access_token', data.access_token)
                localStorage.setItem('refresh_token', data.refresh_token)
              })
              .catch(error => {
                console.error('Error:', error)
              })
          }
        }
      })

      app.component('auth-component', AuthComponent)
      app.component('search-bar', SearchBar)
      app.component('search-results', SearchResults)

      app.mount('#app')
    </script>
  </body>
</html>
